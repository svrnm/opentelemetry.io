---
title: はじめに
weight: 1
# prettier-ignore
cSpell:ignore: filelog kubelet kubeletstats kubeletstatsreceiver loggingexporter otlpexporter sattributes sattributesprocessor sclusterreceiver sobjectsreceiver
---

このページでは、OpenTelemetry を使って Kubernetes クラスターの監視を始める最速の方法を説明します。
Kubernetesクラスター、ノード、ポッド、コンテナのメトリクスとログの収集、そしてクラスタがOTLPデータを出力するサービスをサポートできるようにすることに焦点を当てます。 It will focus on collecting metrics and
logs for Kubernetes clusters, nodes, pods, and containers, as well as enabling
the cluster to support services emitting OTLP data.

Kubernetes で OpenTelemetry が動いているところを見たいのであれば、[OpenTelemetryデモ](/docs/demo/kubernetes-deployment/) から始めるのがベストです。
このデモは OpenTelemetry の実装を説明するためのものですが、Kubernetes 自体を監視する方法の例ではありません。
このウォークスルーを終えたら、デモをインストールして、すべての監視がアクティブなワークロードにどのように反応するかを見るのは楽しい実験になるでしょう。 The
demo is intended to illustrate the implementation of OpenTelemetry, but it is
not intended to be an example of how to monitor Kubernetes itself. Once you
finish with this walkthrough, it can be a fun experiment to install the demo and
see how all the monitoring responds to an active workload.

PrometheusからOpenTelemetryへの移行を始めようとしている場合、あるいはOpenTelemetryコレクターを使ってPrometheusメトリクスを収集することに興味がある場合は、[Prometheusレシーバー](/docs/platforms/kubernetes/collector/components/#prometheus-receiver) を参照してください。

## 概要 {#overview}

Kubernetesは多くの重要なテレメトリーをさまざまな方法で公開しています。
ログ、イベント、多くの異なるオブジェクトのメトリクス、そしてワークロードによって生成されたデータがあります。 It has
logs, events, metrics for many different objects, and the data generated by its
workloads.

このすべてのデータを収集するために、[OpenTelemetryコレクター](/docs/collector/) を使用します。
コレクターは、このデータを効率的に収集し、意味のある方法で強化できる、自由に使えるさまざまなツールを備えています。 The collector has many different
tools at its disposal which allow it to efficiently collect all this data and
enhance it in meaningful ways.

すべてのデータを収集するには、コレクターを2つの方法でインストールする必要があります。
1つは[デーモンセット](/docs/collector/deployment/agent/)として、もう1つは[デプロイメント](/docs/collector/deployment/gateway/)としてです。
コレクターのデーモンセットインストールは、ノード、ポッド、コンテナのサービス、ログ、メトリクスが発するテレメトリーを収集するために使用されます。
コレクターのデプロイメントインストールは、クラスタのメトリクスとイベントの収集に使用されます。 The Daemonset installation of
the collector will be used to collect telemetry emitted by services, logs, and
metrics for nodes, pods, and containers. The deployment installation of the
collector will be used to collect metrics for the cluster and events.

To install the collector, we'll use the
[OpenTelemetry Collector Helm chart](/docs/platforms/kubernetes/helm/collector/),
which comes with a few configuration options that will make configure the
collector easier. If you're unfamiliar with Helm, check out
[the Helm project site](https://helm.sh/). If you're interested in using a
Kubernetes operator, see
[OpenTelemetry Operator](/docs/platforms/kubernetes/operator/), but this guide
will focus on the Helm chart.

## 準備 {#preparation}

このガイドでは、[Kindクラスター](https://kind.sigs.k8s.io/)を使用することを前提に説明しますが、適切と思われるKubernetesクラスターを自由に使用することができます。

すでに[Kindがインストールされている](https://kind.sigs.k8s.io/#installation-and-usage)と仮定して、新しいKindクラスタを作成します。

```sh
kind create cluster
```

すでに [Helm がインストールされている](https://helm.sh/docs/intro/install/) と仮定して、OpenTelemetry Collector Helm チャートを追加し、後でインストールできるようにします。

```sh
helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
```

## デーモンセットコレクター {#daemonset-collector}

Kubernetesのテレメトリーを収集する最初のステップは、ノードとそのノード上で実行されているワークロードに関連するテレメトリーを収集するために、OpenTelemetry Collectorのデーモンセットインスタンスをデプロイすることです。
デーモンセットは、コレクターのこのインスタンスがすべてのノードにインストールされていることを保証するために使用されます。
デーモンセット内のコレクターの各インスタンスは、それが実行されているノードからのみデータを収集します。 A daemonset is used to guarantee that this
instance of the collector is installed on all nodes. Each instance of the
collector in the daemonset will collect data only from the node on which it is
running.

コレクターのこのインスタンスは、以下のコンポーネントを使用します。

- [OTLP レシーバー](https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver): アプリケーションのトレース、メトリクス、ログを収集します。
- [Kubernetes 属性プロセッサー](/docs/platforms/kubernetes/collector/components/#kubernetes-attributes-processor): 受信するアプリケーションのテレメトリーにKubernetesメタデータを追加します。
- [Kubeletstats レシーバー](/docs/platforms/kubernetes/collector/components/#kubeletstats-receiver): Kubelet上のAPIサーバーからノード、ポッド、コンテナのメトリクスをプルします。
- [Filelog レシーバー](/docs/platforms/kubernetes/collector/components/#filelog-receiver): Kubernetesログとstdout/stderrに書き込まれたアプリケーションログを収集します。

Let's break these down.

### OTLPレシーバー {#otlp-receiver}

[OTLP レシーバー](https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver) は、[OTLP フォーマット](/docs/specs/otel/protocol/) でトレース、メトリクス、ログを収集するための最良のソリューションです。
他のフォーマットでアプリケーションのテレメトリーを発信している場合、[コレクターがそのためのレシーバーを持っている](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver)可能性が高いですが、このチュートリアルでは、テレメトリーが OTLP でフォーマットされていると仮定します。 If you are emitting application
telemetry in another format, there is a good chance that
[the Collector has a receiver for it](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver),
but for this tutorial we'll assume the telemetry is formatted in OTLP.

要件ではないですが、ノード上で実行されているアプリケーションが、そのトレース、メトリクス、ログを同じノード上で実行されているコレクターに送信することは一般的なプラクティスです。
これにより、ネットワークの相互作用がシンプルに保たれ、`k8sattributes` プロセッサーを使用してKubernetesのメタデータを簡単に相関させることができます。 This keeps network interactions simple and allows easy correlation of
Kubernetes metadata using the `k8sattributes` processor.

### Kubernetes属性プロセッサー (Kubernetes Atributes Processor) {#kubernetes-attributes-processor}

[Kubernetes属性プロセッサー](/docs/platforms/kubernetes/collector/components/#kubernetes-attributes-processor)は、Kubernetesポッドからテレメトリーを受信するコレクターで強く推奨されるコンポーネントです。
このプロセッサーは、Kubernetesポッドを自動的に検出し、ポッド名やノード名などのメタデータを抽出し、抽出したメタデータをリソース属性としてスパン、メトリクス、ログに追加します。
テレメトリーにKubernetesコンテキストを追加するため、Kubernetes属性プロセッサーを使用すると、アプリケーションのトレース、メトリクス、ログのシグナルを、ポッドのメトリクスやトレースなどのKubernetesテレメトリーと関連付けられます。 This processor automatically discovers Kubernetes pods,
extracts their metadata such as pod name or node name, and adds the extracted
metadata to spans, metrics, and logs as resource attributes. Because it adds
Kubernetes context to your telemetry, the Kubernetes Attributes Processor lets
you correlate your application's traces, metrics, and logs signals with your
Kubernetes telemetry, such as pod metrics and traces.

### Kubeletstatsレシーバー (Kubeletstats Receiver) {#kubeletstats-receiver}

[Kubeletstatsレシーバー](/docs/platforms/kubernetes/collector/components/#kubeletstats-receiver) は、ノードに関するメトリクスを収集するレシーバーです。
コンテナのメモリ使用量、ポッドのCPU使用量、ノードのネットワークエラーなどのメトリクスを収集します。
すべてのテレメトリーには、ポッド名やノード名などのKubernetesメタデータが含まれます。
ここではKubernetes属性プロセッサーを使用しているため、アプリケーションのトレース、メトリクス、ログをKubeletstatsレシーバーが生成したメトリクスと関連付けることができます。 It will gather metrics like
container memory usage, pod cpu usage, and node network errors. All of the
telemetry includes Kubernetes metadata like pod name or node name. Since we're
using the Kubernetes Attributes Processor, we'll be able to correlate our
application traces, metrics, and logs with the metrics produced by the
Kubeletstats Receiver.

### ファイルログレシーバー (Filelog Receiver) {#filelog-receiver}

[ファイルログレシーバー](/docs/platforms/kubernetes/collector/components/#filelog-receiver)は、Kubernetesが `/var/log/pods/*/*.log` に書き込むログをテイルすることで、標準出力/標準エラーに書き込まれたログを収集します。
ほとんどのログテイルツールと同様に、ファイルログレシーバーは、必要な方法でファイルをパースできるように、堅牢なアクションセットを提供します。 Like most log tailers, the filelog receiver
provides a robust set of actions that allow you to parse the file however you
need.

Someday you may need to configure a Filelog Receiver on your own, but for this
walkthrough the OpenTelemetry Helm Chart will handle all the complex
configuration for you. In addition, it will extract useful Kubernetes metadata
based on the file name. Since we're using the Kubernetes Attributes Processor,
we'll be able to correlate the application traces, metrics, and logs with the
logs produced by the Filelog Receiver.

---

OpenTelemetryコレクターHelmチャートは、コレクターのDeamonSetでのインストールにおいて、これらすべてのコンポーネントの設定を簡単にします。
また、RBAC、マウント、ホストポートなど、Kubernetes特有の詳細もすべて引き受けてくれます。 It will also take care of all
of the Kubernetes-specific details, such as RBAC, mounts and host ports.

One caveat - the chart doesn't send the data to any backend by default. If you
want to actually use your data in your favorite backend you'll need to configure
an exporter yourself.

このウォークスルーの例では、以下の`values.yaml`を使用します。

```yaml
mode: daemonset

image:
  repository: otel/opentelemetry-collector-k8s

presets:
  # k8sattributesprocessorを有効にし、トレース、メトリクス、ログのパイプラインに追加します
  kubernetesAttributes:
    enabled: true
  # kubeletstatsreceiverを有効にし、メトリクスパイプラインに追加します
  kubeletMetrics:
    enabled: true
  # ファイルログレシーバーを有効にし、ログパイプラインに追加します
  logsCollection:
    enabled: true
## チャートにはデフォルトでloggingexporterしか含まれていません
## データをどこかに送りたい場合は、otlpexporterのようなエクスポーターを設定する必要があります
# config:
#   exporters:
#     otlp:
#       endpoint: "<SOME BACKEND>"
#   service:
#     pipelines:
#       traces:
#         exporters: [ otlp ]
#       metrics:
#         exporters: [ otlp ]
#       logs:
#         exporters: [ otlp ]
```

この `values.yaml` をチャートと一緒に使うには、ファイルを好きな場所に保存してから、以下のコマンドを実行してチャートをインストールします。

```sh
helm install otel-collector open-telemetry/opentelemetry-collector --values <チャートを保存した場所へのパス>
```

これで、OpenTelemetry コレクターのDaemonSetのインストールがクラスタ内で実行され、各ノードからテレメトリーが収集されるはずです！

## デプロイメントコレクター {#deployment-collector}

Kubernetesのテレメトリーを収集する次のステップは、クラスタ全体に関連するテレメトリーを収集するためにコレクターのデプロイメントインスタンスをデプロイすることです。
正確に1つのレプリカを持つデプロイは、重複したデータを生成しないことを保証します。
A deployment with exactly one replica ensures that we don't produce duplicate
data.

コレクターのこのインスタンスは、以下のコンポーネントを使用します。

- [Kubernetesクラスターレシーバー](/docs/platforms/kubernetes/collector/components/#kubernetes-cluster-receiver): クラスターレベルのメトリクスとエンティティイベントを収集します。
- [Kubernetesオブジェクトレシーバー](/docs/platforms/kubernetes/collector/components/#kubernetes-objects-receiver): Kubernetes APIサーバーからイベントなどのオブジェクトを収集します。

Let's break these down.

### Kubernetesクラスターレシーバー (Kubernetes Cluster Receiver) {#kubernetes-cluster-receiver}

[Kubernetesクラスターレシーバー](/docs/platforms/kubernetes/collector/components/#kubernetes-cluster-receiver)は、クラスター全体の状態に関するメトリクスを収集するためのコレクターのソリューションです。
このレシーバーは、ノードの状態、ポッドのフェーズ、コンテナの再起動、利用可能なデプロイメントと希望するデプロイメントなどに関するメトリクスを収集できます。 This receiver can gather metrics about node conditions, pod
phases, container restarts, available and desired deployments, and more.

### Kubernetesオブジェクトレシーバー (Kubernetes Objects Receiver) {#kubernetes-objects-receiver}

[Kubernetesオブジェクトレシーバー](/docs/platforms/kubernetes/collector/components/#kubernetes-objects-receiver) は、Kubernetesオブジェクトをログとして収集するためのコレクターのソリューションです。
どんなオブジェクトでも収集できますが、一般的で重要なユースケースはKubernetesイベントを収集することです。 Although
any object can be collected, a common and important use case is to collect
Kubernetes events.

---

OpenTelemetryコレクターHelmチャートは、コレクターのデプロイメントインストールにおけるこれらすべてのコンポーネントの設定を効率化します。
また、RBAC やマウントといった Kubernetes 固有の詳細もすべて引き受けてくれます。 It will also
take care of all of the Kubernetes-specific details, such as RBAC and mounts.

1つ注意事項があります。
チャートはデフォルトではどのバックエンドにもデータを送信しません。
もし実際にあなたの好みのバックエンドでデータを使いたい場合は、自分でエクスポーターを設定する必要があります。 If you
want to actually use your data in your preferred backend, you'll need to
configure an exporter yourself.

このウォークスルーの例では、以下の`values.yaml`を使用します。

```yaml
mode: deployment

image:
  repository: otel/opentelemetry-collector-k8s

# これらのコレクターは1つだけ必要で、それ以上は重複したデータを生成することになります
replicaCount: 1

presets:
  # k8sclusterreceiverを有効にし、メトリクスパイプラインに追加します
  clusterMetrics:
    enabled: true
  # k8sobjectsreceiverがイベントのみを収集するようにし、ログパイプラインに追加します
  kubernetesEvents:
    enabled: true
## チャートにはデフォルトでloggingexporterしか含まれていません
## データをどこかに送りたい場合は、otlpexporterのようなエクスポーターを設定する必要があります
# config:
# exporters:
#   otlp:
#     endpoint: "<SOME BACKEND>"
# service:
#   pipelines:
#     traces:
#       exporters: [ otlp ]
#     metrics:
#       exporters: [ otlp ]
#     logs:
#       exporters: [ otlp ]
```

この `values.yaml` をチャートで使用するには、ファイルを好きな場所に保存してから、以下のコマンドを実行してチャートをインストールしてください。

```sh
helm install otel-collector-cluster open-telemetry/opentelemetry-collector --values <チャートを保存した場所へのパス>
```

これで、クラスタメトリクスとイベントを収集するコレクターのデプロイメントインストールがクラスタで実行されるはずです！
